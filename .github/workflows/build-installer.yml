name: Build Windows Installer and Attach to Release

on:
  push:
    tags: 
        - 'v?[0-9]+.[0-9]+.[0-9]+'
    branches: 
        - 'release/**'
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build:
    name: Build and Package for Windows x64
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'release' && github.event.action == 'published')
    runs-on: windows-latest
    outputs:
      installer_filename: ${{ steps.get_installer_path.outputs.name }}
      clean_version: ${{ steps.version_info.outputs.clean_version }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event_name == 'release' && github.event.release.tag_name || github.ref }}
        fetch-depth: 0 

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Install Inno Setup
      shell: powershell
      run: |
        choco install innosetup --no-progress
        if (Test-Path "C:\Program Files (x86)\Inno Setup 6\ISCC.exe") {
            Write-Host "Inno Setup installed successfully."
        } else {
            Write-Error "Inno Setup executable not found."
            exit 1
        }

    - name: Determine Version from Tag
      id: version_info
      shell: powershell
      run: |
        $versionString = ""
        if ("${{ github.event_name }}" -eq "release") {
          $versionString = "${{ github.event.release.tag_name }}"
        } elseif ("${{ github.event_name }}" -eq "push") {
          $versionString = "${{ github.ref_name }}"
        } elseif ("${{ github.event_name }}" -eq "workflow_dispatch") {
          if ("${{ github.ref }}".StartsWith("refs/tags/")) {
            $versionString = "${{ github.ref_name }}"
          } else {
            $versionString = "0.0.0-manual" 
          }
        } else {
          $versionString = "0.0.0-unknown" 
        }
        $cleanVersion = $versionString -replace '^v', ''
        # Sanitize for Inno Setup (replace slashes from branch names with dashes)
        $cleanVersion = $cleanVersion -replace '[/\\:]', '-'
        Write-Host "Determined clean version: $cleanVersion"
        echo "clean_version=$cleanVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

    - name: Restore dependencies
      run: dotnet restore Repo2Text.csproj

    - name: Publish application
      run: dotnet publish Repo2Text.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=false -p:PublishReadyToRun=true -o ./publish_output

    - name: Compile Inno Setup script
      shell: powershell 
      env:
        APP_VERSION_CLEAN: ${{ steps.version_info.outputs.clean_version }}
      run: |
        $effectiveVersion = $env:APP_VERSION_CLEAN
        $isccArguments = "/DMyAppVersionFromWorkflow=`"$effectiveVersion`""
        $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        & $isccPath $isccArguments Repo2Text.iss
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

    - name: Prepare Installer Info
      id: get_installer_path
      shell: powershell
      env:
        EXPECTED_VERSION_FROM_BUILD: ${{ steps.version_info.outputs.clean_version }} 
      run: |
        $installerDir = ".\installer_output\"
        $isccVersion = $env:EXPECTED_VERSION_FROM_BUILD
        $expectedFileName = "Repo2Text_Setup_v${isccVersion}.exe"
        $fullPathToExpectedFile = Join-Path -Path $installerDir -ChildPath $expectedFileName
        
        if (-not (Test-Path $fullPathToExpectedFile)) {
          Write-Error "Expected installer file '$expectedFileName' not found."
          exit 1
        }
        
        echo "path=$fullPathToExpectedFile" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
        echo "name=$expectedFileName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
        
    - name: Upload Installer Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Repo2Text-Installer-Windows-x64
        path: ${{ steps.get_installer_path.outputs.path }}

  upload_to_release:
    name: Upload Installer to GitHub Release
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'release' && github.event.action == 'published')
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Download installer artifact
      uses: actions/download-artifact@v4
      with:
        name: Repo2Text-Installer-Windows-x64
        path: ./installer_download

    - name: Upload Release Asset
      uses: softprops/action-gh-release@v2
      with:
        files: ./installer_download/${{ needs.build.outputs.installer_filename }}
        tag_name: ${{ github.event_name == 'release' && github.event.release.tag_name || (startsWith(github.ref, 'refs/tags/') && github.ref_name || format('manual-{0}', needs.build.outputs.clean_version)) }}
        name: ${{ github.event_name == 'release' && github.event.release.name || (startsWith(github.ref, 'refs/tags/') && github.ref_name || format('Manual Release {0}', needs.build.outputs.clean_version)) }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}